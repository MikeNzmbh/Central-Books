{% extends "base.html" %}

{% block title %}Bank feed – Clover Books{% endblock %}

{% block content %}
<div class="mb-page-shell">
  <div class="mb-page-header">
    <div>
      <div class="mb-kicker">BANKING</div>
      <h1 class="mb-page-title">Bank feed</h1>
      <p class="mb-page-subtitle">
        Import statements and review transactions from your bank accounts. Once
        reconciled, your ledger, Profit &amp; Loss, and tax reports all stay in sync.
      </p>
    </div>
    <div class="mb-page-actions">
      <a href="{% url 'bank_import' %}"
         class="mb-btn mb-btn-pill {% if rows %}mb-btn-primary{% else %}mb-btn-secondary{% endif %}">
        Import CSV
      </a>
    </div>
  </div>

  <div class="mb-page-grid" style="grid-template-columns:minmax(0,3fr) minmax(0,2fr);">
    <div class="mb-page-main space-y-4">
      {% if rows %}
        {% for row in rows %}
        {% with ba=row.bank_account %}
        <div class="mb-card">
          <div class="mb-card-header">
            <div>
              <h2 class="mb-card-title">
                {{ ba.name }}
                {% if ba.account_number_mask %}
                  <span class="text-xs font-normal text-slate-400">•••• {{ ba.account_number_mask }}</span>
                {% endif %}
              </h2>
              <p class="mb-card-subtitle">
                {% if ba.account %}
                  Linked to ledger account {{ ba.account.code }} – {{ ba.account.name }}
                {% else %}
                  Not linked to the ledger yet (optional in v1).
                {% endif %}
              </p>
            </div>
            <div class="text-right">
              <div class="text-xs uppercase tracking-[0.14em] text-slate-400">Ledger balance</div>
              <div class="text-lg font-semibold">${{ row.balance|floatformat:2 }}</div>
            </div>
          </div>
          <div class="mb-card-body flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
            <div class="text-xs text-slate-500 space-y-1">
              <div>
                <span class="font-semibold text-slate-600">Last import:</span>
                {% if row.last_imported_at %}
                  {{ row.last_imported_at|date:"M d, Y H:i" }}
                {% else %}
                  Never imported
                {% endif %}
              </div>
              {% if row.last_import_status %}
                <div>
                  <span class="font-semibold text-slate-600">Status:</span>
                  <span class="inline-flex items-center rounded-full px-2 py-[2px] text-[11px] font-semibold
                               {% if row.last_import_status == 'COMPLETED' %}bg-emerald-50 text-emerald-700
                               {% elif row.last_import_status == 'PROCESSING' %}bg-sky-50 text-sky-700
                               {% elif row.last_import_status == 'FAILED' %}bg-rose-50 text-rose-700
                               {% else %}bg-slate-50 text-slate-600{% endif %}">
                    {{ row.last_import_status|title }}
                  </span>
                </div>
              {% endif %}
            </div>
            <div class="flex gap-2">
              <a href="{% url 'bank_import' %}?bank_account={{ ba.id }}"
                 class="mb-btn mb-btn-pill mb-btn-secondary">
                Import CSV
              </a>
              <a href="{% url 'bank_feed_review' ba.id %}"
                 class="mb-btn mb-btn-pill mb-btn-primary">
                Review transactions
              </a>
            </div>
          </div>
        </div>
        {% endwith %}
        {% endfor %}
      {% else %}
        <div class="mb-card">
          <div class="mb-card-body">
            <h2 class="mb-card-title mb-2">No bank accounts yet</h2>
            <p class="mb-card-subtitle mb-4">
              Add a bank account first, then you can import CSV statements and review transactions.
            </p>
            <a href="{% url 'bank_account_create' %}" class="mb-btn mb-btn-pill mb-btn-primary">+ New bank account</a>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="mb-page-side space-y-4">
      <div class="mb-card">
        <div class="mb-card-header">
          <h2 class="mb-card-title">Bank feed snapshot</h2>
        </div>
        <div class="mb-card-body text-xs text-slate-600 space-y-2">
          <p>
            As of {{ as_of|date:"M d, Y" }}, your bank accounts are linked to ledger asset accounts. Once you import CSV files and review transactions, Clover Books will keep your cash, Profit &amp; Loss, and tax summaries aligned.
          </p>
          <ul class="list-disc pl-4 space-y-1">
            <li>Use <strong>Import CSV</strong> to load new bank statements.</li>
            <li>Use <strong>Review transactions</strong> to match or create expenses and income.</li>
            <li>Matched items flow directly into your ledger and reports.</li>
          </ul>
        </div>
      </div>

      <div class="mb-card">
        <div class="mb-card-header">
          <h2 class="mb-card-title">Coming soon</h2>
        </div>
        <div class="mb-card-body text-xs text-slate-600 space-y-1">
          <p>
            Future updates will add reconciliation status, unmatched-item alerts, and automatic bank connections so you can keep every dollar in sync without manual uploads.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
